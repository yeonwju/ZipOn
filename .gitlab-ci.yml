image: curlimages/curl:8.10.1

stages:
  - trigger_jenkins

# DEV
trigger-dev:
  stage: trigger_jenkins
  only:
    - dev
  tags:
    - zipon
  script:
    - echo "ğŸš€ Trigger Jenkins (DEV job)"

    # 1) Jenkins Crumb ê°€ì ¸ì˜¤ê¸°
    - |
      CRUMB=$(curl -s \
        --user "$JENKINS_USER:$JENKINS_TOKEN" \
        "http://k13a303.p.ssafy.io:8888/crumbIssuer/api/xml?xpath=concat(//crumbRequestField,\":\",//crumb)")
      echo "âœ“ CRUMB = $CRUMB"

    # 2) Jenkins DEV Job ë¹Œë“œ ì‹œì‘
    - |
      curl -X POST \
        "http://k13a303.p.ssafy.io:8888/job/zipon-app/job/dev/build" \
        -H "$CRUMB" \
        --user "$JENKINS_USER:$JENKINS_TOKEN"

    - echo "â³ Waiting for Jenkins to start build..."
    - sleep 3

    # 3) ê°€ì¥ ìµœê·¼ ë¹Œë“œ ë²ˆí˜¸ ì¡°íšŒ
    - |
      BUILD_NUMBER=$(curl -s \
        --user "$JENKINS_USER:$JENKINS_TOKEN" \
        "http://k13a303.p.ssafy.io:8888/job/zipon-app/job/dev/lastBuild/buildNumber")
      echo "ğŸ”¢ Jenkins BUILD_NUMBER = $BUILD_NUMBER"

    # 4) ì½˜ì†” ì¶œë ¥ ì¡°íšŒ
    - |
      echo "ğŸ“œ Fetching Jenkins Console Output..."
      curl -s \
        --user "$JENKINS_USER:$JENKINS_TOKEN" \
        "http://k13a303.p.ssafy.io:8888/job/zipon-app/job/dev/$BUILD_NUMBER/consoleText"

    - echo "âœ… DEV pipeline Done."

# MASTER
trigger-master:
  stage: trigger_jenkins
  only:
    - master
  tags:
    - zipon
  script:
    - echo "ğŸš€ Trigger Jenkins (MASTER job)"

    # 1) Jenkins Crumb ê°€ì ¸ì˜¤ê¸°
    - |
      CRUMB=$(curl -s \
        --user "$JENKINS_USER:$JENKINS_TOKEN" \
        "http://k13a303.p.ssafy.io:8888/crumbIssuer/api/xml?xpath=concat(//crumbRequestField,\":\",//crumb)")
      echo "âœ“ CRUMB = $CRUMB"

    # 2) Jenkins MASTER Job ë¹Œë“œ ì‹œì‘
    - |
      curl -X POST \
        "http://k13a303.p.ssafy.io:8888/job/zipon-app/job/master/build" \
        -H "$CRUMB" \
        --user "$JENKINS_USER:$JENKINS_TOKEN"

    - echo "â³ Waiting for Jenkins to start build..."
    - sleep 3

    # 3) ê°€ì¥ ìµœê·¼ ë¹Œë“œ ë²ˆí˜¸ ì¡°íšŒ
    - |
      BUILD_NUMBER=$(curl -s \
        --user "$JENKINS_USER:$JENKINS_TOKEN" \
        "http://k13a303.p.ssafy.io:8888/job/zipon-app/job/master/lastBuild/buildNumber")
      echo "ğŸ”¢ Jenkins BUILD_NUMBER = $BUILD_NUMBER"

    # 4) ì½˜ì†” ì¶œë ¥ ì¡°íšŒ
    - |
      echo "ğŸ“œ Fetching Jenkins Console Output..."
      curl -s \
        --user "$JENKINS_USER:$JENKINS_TOKEN" \
        "http://k13a303.p.ssafy.io:8888/job/zipon-app/job/master/$BUILD_NUMBER/consoleText"

    - echo "âœ… MASTER pipeline Done."
