image: curlimages/curl:8.10.1

stages:
  - trigger_jenkins

# dev
trigger-dev:
  stage: trigger_jenkins
  only:
    - dev
  script:
    - echo "ğŸš€ Trigger Jenkins (DEV job)"

    # 1) Jenkins ë¹Œë“œ ì‹œì‘
    - |
      curl -X POST "http://k13a303.p.ssafy.io:8888/job/dev/build?token=trigger" \
        --user "$JENKINS_USER:$JENKINS_TOKEN"

    - echo "â³ Waiting for Jenkins to start build..."
    - sleep 3

    # 2) ìµœê·¼ ë¹Œë“œë²ˆí˜¸ ê°€ì ¸ì˜¤ê¸°
    - |
      BUILD_NUMBER=$(curl -s "http://k13a303.p.ssafy.io:8888/job/dev/lastBuild/buildNumber" \
        --user "$JENKINS_USER:$JENKINS_TOKEN")
      echo "ğŸ”¢ Jenkins BUILD_NUMBER = $BUILD_NUMBER"

    # 3) ì½˜ì†” ì¶œë ¥ ê°€ì ¸ì˜¤ê¸°
    - |
      echo "ğŸ“œ Fetching Jenkins Console Output..."
      curl -s "http://k13a303.p.ssafy.io:8888/job/dev/$BUILD_NUMBER/consoleText" \
        --user "$JENKINS_USER:$JENKINS_TOKEN"

    - echo "âœ… DEV pipeline Done."

# master
trigger-master:
  stage: trigger_jenkins
  only:
    - master
  script:
    - echo "ğŸš€ Trigger Jenkins (MASTER job)"

    # 1) Jenkins ë¹Œë“œ ì‹œì‘
    - |
      curl -X POST "http://k13a303.p.ssafy.io:8888/job/master/build?token=trigger" \
        --user "$JENKINS_USER:$JENKINS_TOKEN"

    - echo "â³ Waiting for Jenkins to start build..."
    - sleep 3

    # 2) ìµœê·¼ ë¹Œë“œë²ˆí˜¸ ê°€ì ¸ì˜¤ê¸°
    - |
      BUILD_NUMBER=$(curl -s "http://k13a303.p.ssafy.io:8888/job/master/lastBuild/buildNumber" \
        --user "$JENKINS_USER:$JENKINS_TOKEN")
      echo "ğŸ”¢ Jenkins BUILD_NUMBER = $BUILD_NUMBER"

    # 3) ì½˜ì†” ì¶œë ¥ ê°€ì ¸ì˜¤ê¸°
    - |
      echo "ğŸ“œ Fetching Jenkins Console Output..."
      curl -s "http://k13a303.p.ssafy.io:8888/job/master/$BUILD_NUMBER/consoleText" \
        --user "$JENKINS_USER:$JENKINS_TOKEN"

    - echo "âœ… MASTER pipeline Done."
